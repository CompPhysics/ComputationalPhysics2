<!--
HTML file automatically generated from DocOnce source
(https://github.com/doconce/doconce/)
doconce format html week9.do.txt --html_style=bootstrap --pygments_html_style=default --html_admon=bootstrap_panel --html_output=week9-bs --no_mako
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="DocOnce: https://github.com/doconce/doconce/" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="Week 11, March 11-15: Resampling Techniques, Bootstrap and Blocking">
<title>Week 11, March 11-15: Resampling Techniques, Bootstrap and Blocking</title>
<!-- Bootstrap style: bootstrap -->
<!-- doconce format html week9.do.txt --html_style=bootstrap --pygments_html_style=default --html_admon=bootstrap_panel --html_output=week9-bs --no_mako -->
<link href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
<!-- not necessary
<link href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
-->
<style type="text/css">
/* Add scrollbar to dropdown menus in bootstrap navigation bar */
.dropdown-menu {
   height: auto;
   max-height: 400px;
   overflow-x: hidden;
}
/* Adds an invisible element before each target to offset for the navigation
   bar */
.anchor::before {
  content:"";
  display:block;
  height:50px;      /* fixed header height for style bootstrap */
  margin:-50px 0 0; /* negative fixed header height */
}
</style>
</head>

<!-- tocinfo
{'highest level': 2,
 'sections': [('Overview of week 11, March 11-15',
               2,
               None,
               'overview-of-week-11-march-11-15'),
              ('Why resampling methods ?', 2, None, 'why-resampling-methods'),
              ('Statistical analysis', 2, None, 'statistical-analysis'),
              ('And why do we use such methods?',
               2,
               None,
               'and-why-do-we-use-such-methods'),
              ('Central limit theorem', 2, None, 'central-limit-theorem'),
              ('Further remarks', 2, None, 'further-remarks'),
              ('Running many measurements',
               2,
               None,
               'running-many-measurements'),
              ('Adding more definitions', 2, None, 'adding-more-definitions'),
              ('Further rewriting', 2, None, 'further-rewriting'),
              ('The covariance term', 2, None, 'the-covariance-term'),
              ('Rewriting the covariance term',
               2,
               None,
               'rewriting-the-covariance-term'),
              ('Introducing the correlation function',
               2,
               None,
               'introducing-the-correlation-function'),
              ('Computing the correlation function',
               2,
               None,
               'computing-the-correlation-function'),
              ('Resampling methods: Blocking',
               2,
               None,
               'resampling-methods-blocking'),
              ('Why blocking?', 2, None, 'why-blocking'),
              ('Blocking Transformations', 2, None, 'blocking-transformations'),
              ('Blocking transformations', 2, None, 'blocking-transformations'),
              ('Blocking Transformations', 2, None, 'blocking-transformations'),
              ('Blocking Transformations, getting there',
               2,
               None,
               'blocking-transformations-getting-there'),
              ('Blocking Transformations, final expressions',
               2,
               None,
               'blocking-transformations-final-expressions'),
              ('More on the blocking method',
               2,
               None,
               'more-on-the-blocking-method'),
              ('Example code form last week',
               2,
               None,
               'example-code-form-last-week'),
              ('Resampling analysis', 2, None, 'resampling-analysis'),
              ('Content', 2, None, 'content'),
              ('Optimization and profiling',
               2,
               None,
               'optimization-and-profiling'),
              ('More on optimization', 2, None, 'more-on-optimization'),
              ('Optimization and profiling',
               2,
               None,
               'optimization-and-profiling'),
              ('Optimization and debugging',
               2,
               None,
               'optimization-and-debugging'),
              ('Other hints', 2, None, 'other-hints'),
              ('Vectorization and the basic idea behind parallel computing',
               2,
               None,
               'vectorization-and-the-basic-idea-behind-parallel-computing'),
              ('A rough classification of hardware models',
               2,
               None,
               'a-rough-classification-of-hardware-models'),
              ('Shared memory and distributed memory',
               2,
               None,
               'shared-memory-and-distributed-memory'),
              ('Different parallel programming paradigms',
               2,
               None,
               'different-parallel-programming-paradigms'),
              ('Different parallel programming paradigms',
               2,
               None,
               'different-parallel-programming-paradigms'),
              ('What is vectorization?', 2, None, 'what-is-vectorization'),
              ('Number of elements that can acted upon',
               2,
               None,
               'number-of-elements-that-can-acted-upon'),
              ('Number of elements that can acted upon, examples',
               2,
               None,
               'number-of-elements-that-can-acted-upon-examples'),
              ('Operation counts for scalar operation',
               2,
               None,
               'operation-counts-for-scalar-operation'),
              ('Number of elements that can acted upon, examples',
               2,
               None,
               'number-of-elements-that-can-acted-upon-examples'),
              ('Number of operations when vectorized',
               2,
               None,
               'number-of-operations-when-vectorized'),
              ('"A simple test case with and without '
               'vectorization":"https://github.com/CompPhysics/ComputationalPhysicsMSU/blob/master/doc/Programs/LecturePrograms/programs/Classes/cpp/program7.cpp"',
               2,
               None,
               'a-simple-test-case-with-and-without-vectorization-https-github-com-compphysics-computationalphysicsmsu-blob-master-doc-programs-lectureprograms-programs-classes-cpp-program7-cpp'),
              ('Compiling with and without vectorization',
               2,
               None,
               'compiling-with-and-without-vectorization'),
              ('Compiling with and without vectorization using clang',
               2,
               None,
               'compiling-with-and-without-vectorization-using-clang'),
              ('Automatic vectorization and vectorization inhibitors, criteria',
               2,
               None,
               'automatic-vectorization-and-vectorization-inhibitors-criteria'),
              ('Automatic vectorization and vectorization inhibitors, exit '
               'criteria',
               2,
               None,
               'automatic-vectorization-and-vectorization-inhibitors-exit-criteria'),
              ('Automatic vectorization and vectorization inhibitors, '
               'straight-line code',
               2,
               None,
               'automatic-vectorization-and-vectorization-inhibitors-straight-line-code'),
              ('Automatic vectorization and vectorization inhibitors, nested '
               'loops',
               2,
               None,
               'automatic-vectorization-and-vectorization-inhibitors-nested-loops'),
              ('Automatic vectorization and vectorization inhibitors, function '
               'calls',
               2,
               None,
               'automatic-vectorization-and-vectorization-inhibitors-function-calls'),
              ('Automatic vectorization and vectorization inhibitors, data '
               'dependencies',
               2,
               None,
               'automatic-vectorization-and-vectorization-inhibitors-data-dependencies'),
              ('Automatic vectorization and vectorization inhibitors, more '
               'data dependencies',
               2,
               None,
               'automatic-vectorization-and-vectorization-inhibitors-more-data-dependencies'),
              ('Automatic vectorization and vectorization inhibitors, memory '
               'stride',
               2,
               None,
               'automatic-vectorization-and-vectorization-inhibitors-memory-stride'),
              ('Memory management', 2, None, 'memory-management'),
              ('Memory and communication', 2, None, 'memory-and-communication'),
              ('Measuring performance', 2, None, 'measuring-performance'),
              ('Problems with measuring time',
               2,
               None,
               'problems-with-measuring-time'),
              ('Problems with cold start', 2, None, 'problems-with-cold-start'),
              ('Problems with smart compilers',
               2,
               None,
               'problems-with-smart-compilers'),
              ('Problems with interference',
               2,
               None,
               'problems-with-interference'),
              ('Problems with measuring performance',
               2,
               None,
               'problems-with-measuring-performance'),
              ('Thomas algorithm for tridiagonal linear algebra equations',
               2,
               None,
               'thomas-algorithm-for-tridiagonal-linear-algebra-equations'),
              ('Thomas algorithm, forward substitution',
               2,
               None,
               'thomas-algorithm-forward-substitution'),
              ('Thomas algorithm, backward substitution',
               2,
               None,
               'thomas-algorithm-backward-substitution'),
              ('Thomas algorithm and counting of operations (floating point '
               'and memory)',
               2,
               None,
               'thomas-algorithm-and-counting-of-operations-floating-point-and-memory'),
              ('"Example: Transpose of a '
               'matrix":"https://github.com/CompPhysics/ComputationalPhysicsMSU/blob/master/doc/Programs/LecturePrograms/programs/Classes/cpp/program8.cpp"',
               2,
               None,
               'example-transpose-of-a-matrix-https-github-com-compphysics-computationalphysicsmsu-blob-master-doc-programs-lectureprograms-programs-classes-cpp-program8-cpp'),
              ('"Matrix-matrix '
               'multiplication":"https://github.com/CompPhysics/ComputationalPhysicsMSU/blob/master/doc/Programs/LecturePrograms/programs/Classes/cpp/program9.cpp"',
               2,
               None,
               'matrix-matrix-multiplication-https-github-com-compphysics-computationalphysicsmsu-blob-master-doc-programs-lectureprograms-programs-classes-cpp-program9-cpp'),
              ('How do we define speedup? Simplest form',
               2,
               None,
               'how-do-we-define-speedup-simplest-form'),
              ('How do we define speedup? Correct baseline',
               2,
               None,
               'how-do-we-define-speedup-correct-baseline'),
              ('Parallel  speedup', 2, None, 'parallel-speedup'),
              ('Speedup and memory', 2, None, 'speedup-and-memory'),
              ('Upper bounds on speedup', 2, None, 'upper-bounds-on-speedup'),
              ("Amdahl's law", 2, None, 'amdahl-s-law'),
              ('How much is parallelizable',
               2,
               None,
               'how-much-is-parallelizable'),
              ("Today's situation of parallel computing",
               2,
               None,
               'today-s-situation-of-parallel-computing'),
              ('Overhead present in parallel computing',
               2,
               None,
               'overhead-present-in-parallel-computing'),
              ('Parallelizing a sequential algorithm',
               2,
               None,
               'parallelizing-a-sequential-algorithm'),
              ('Strategies', 2, None, 'strategies'),
              ('How do I run MPI on a PC/Laptop? MPI',
               2,
               None,
               'how-do-i-run-mpi-on-a-pc-laptop-mpi'),
              ('Can I do it on my own PC/laptop? OpenMP installation',
               2,
               None,
               'can-i-do-it-on-my-own-pc-laptop-openmp-installation'),
              ('Installing MPI', 2, None, 'installing-mpi'),
              ('Installing MPI and using Qt',
               2,
               None,
               'installing-mpi-and-using-qt'),
              ('What is Message Passing Interface (MPI)?',
               2,
               None,
               'what-is-message-passing-interface-mpi'),
              ('Going Parallel with MPI', 2, None, 'going-parallel-with-mpi'),
              ('MPI is a library', 2, None, 'mpi-is-a-library'),
              ('Bindings to MPI routines', 2, None, 'bindings-to-mpi-routines'),
              ('Communicator', 2, None, 'communicator'),
              ('Some of the most  important MPI functions',
               2,
               None,
               'some-of-the-most-important-mpi-functions'),
              ('"The first MPI C/C++ '
               'program":"https://github.com/CompPhysics/ComputationalPhysics2/blob/gh-pages/doc/Programs/LecturePrograms/programs/MPI/chapter07/program2.cpp"',
               2,
               None,
               'the-first-mpi-c-c-program-https-github-com-compphysics-computationalphysics2-blob-gh-pages-doc-programs-lectureprograms-programs-mpi-chapter07-program2-cpp'),
              ('The Fortran program', 2, None, 'the-fortran-program'),
              ('Note 1', 2, None, 'note-1'),
              ('"Ordered output with '
               'MPIBarrier":"https://github.com/CompPhysics/ComputationalPhysics2/blob/gh-pages/doc/Programs/LecturePrograms/programs/MPI/chapter07/program3.cpp"',
               2,
               None,
               'ordered-output-with-mpibarrier-https-github-com-compphysics-computationalphysics2-blob-gh-pages-doc-programs-lectureprograms-programs-mpi-chapter07-program3-cpp'),
              ('Note 2', 2, None, 'note-2'),
              ('"Ordered '
               'output":"https://github.com/CompPhysics/ComputationalPhysics2/blob/gh-pages/doc/Programs/LecturePrograms/programs/MPI/chapter07/program4.cpp"',
               2,
               None,
               'ordered-output-https-github-com-compphysics-computationalphysics2-blob-gh-pages-doc-programs-lectureprograms-programs-mpi-chapter07-program4-cpp'),
              ('Note 3', 2, None, 'note-3'),
              ('Note 4', 2, None, 'note-4'),
              ('"Numerical integration in '
               'parallel":"https://github.com/CompPhysics/ComputationalPhysics2/blob/gh-pages/doc/Programs/LecturePrograms/programs/MPI/chapter07/program6.cpp"',
               2,
               None,
               'numerical-integration-in-parallel-https-github-com-compphysics-computationalphysics2-blob-gh-pages-doc-programs-lectureprograms-programs-mpi-chapter07-program6-cpp'),
              ('Dissection of trapezoidal rule with $MPI\\_reduce$',
               2,
               None,
               'dissection-of-trapezoidal-rule-with-mpi-reduce'),
              ('Dissection of trapezoidal rule',
               2,
               None,
               'dissection-of-trapezoidal-rule'),
              ('Integrating with _MPI_', 2, None, 'integrating-with-mpi'),
              ('How do I use $MPI\\_reduce$?',
               2,
               None,
               'how-do-i-use-mpi-reduce'),
              ('More on $MPI\\_Reduce$', 2, None, 'more-on-mpi-reduce'),
              ('Dissection of trapezoidal rule',
               2,
               None,
               'dissection-of-trapezoidal-rule'),
              ('Dissection of trapezoidal rule',
               2,
               None,
               'dissection-of-trapezoidal-rule'),
              ('"The quantum dot program for two '
               'electrons":"https://github.com/CompPhysics/ComputationalPhysics2/blob/master/doc/Programs/ParallelizationMPI/MPIvmcqdot.cpp"',
               2,
               None,
               'the-quantum-dot-program-for-two-electrons-https-github-com-compphysics-computationalphysics2-blob-master-doc-programs-parallelizationmpi-mpivmcqdot-cpp'),
              ('What is OpenMP', 2, None, 'what-is-openmp'),
              ('Getting started, things to remember',
               2,
               None,
               'getting-started-things-to-remember'),
              ('OpenMP syntax', 2, None, 'openmp-syntax'),
              ('Different OpenMP styles of parallelism',
               2,
               None,
               'different-openmp-styles-of-parallelism'),
              ('General code structure', 2, None, 'general-code-structure'),
              ('Parallel region', 2, None, 'parallel-region'),
              ('Hello world, not again, please!',
               2,
               None,
               'hello-world-not-again-please'),
              ('Hello world, yet another variant',
               2,
               None,
               'hello-world-yet-another-variant'),
              ('Important OpenMP library routines',
               2,
               None,
               'important-openmp-library-routines'),
              ('Private variables', 2, None, 'private-variables'),
              ('Master region', 2, None, 'master-region'),
              ('Parallel for loop', 2, None, 'parallel-for-loop'),
              ('Parallel computations and loops',
               2,
               None,
               'parallel-computations-and-loops'),
              ('Scheduling of  loop computations',
               2,
               None,
               'scheduling-of-loop-computations'),
              ('Example code for loop scheduling',
               2,
               None,
               'example-code-for-loop-scheduling'),
              ('Example code for loop scheduling, guided instead of dynamic',
               2,
               None,
               'example-code-for-loop-scheduling-guided-instead-of-dynamic'),
              ('More on Parallel for loop',
               2,
               None,
               'more-on-parallel-for-loop'),
              ('What can happen with this loop?',
               2,
               None,
               'what-can-happen-with-this-loop'),
              ('Inner product', 2, None, 'inner-product'),
              ('Different threads do different tasks',
               2,
               None,
               'different-threads-do-different-tasks'),
              ('Single execution', 2, None, 'single-execution'),
              ('Coordination and synchronization',
               2,
               None,
               'coordination-and-synchronization'),
              ('Data scope', 2, None, 'data-scope'),
              ('Some remarks', 2, None, 'some-remarks'),
              ('Parallelizing nested for-loops',
               2,
               None,
               'parallelizing-nested-for-loops'),
              ('Nested parallelism', 2, None, 'nested-parallelism'),
              ('Parallel tasks', 2, None, 'parallel-tasks'),
              ('Common mistakes', 2, None, 'common-mistakes'),
              ('Not all computations are simple',
               2,
               None,
               'not-all-computations-are-simple'),
              ('Not all computations are simple, competing threads',
               2,
               None,
               'not-all-computations-are-simple-competing-threads'),
              ('How to find the max value using OpenMP',
               2,
               None,
               'how-to-find-the-max-value-using-openmp'),
              ('Then deal with the race conditions',
               2,
               None,
               'then-deal-with-the-race-conditions'),
              ('What can slow down OpenMP performance?',
               2,
               None,
               'what-can-slow-down-openmp-performance'),
              ('What can slow down OpenMP performance?',
               2,
               None,
               'what-can-slow-down-openmp-performance'),
              ('Find the max location for each thread',
               2,
               None,
               'find-the-max-location-for-each-thread'),
              ('Combine the values from each thread',
               2,
               None,
               'combine-the-values-from-each-thread'),
              ('"Matrix-matrix '
               'multiplication":"https://github.com/CompPhysics/ComputationalPhysicsMSU/blob/master/doc/Programs/ParallelizationOpenMP/OpenMPvectornorm.cpp"',
               2,
               None,
               'matrix-matrix-multiplication-https-github-com-compphysics-computationalphysicsmsu-blob-master-doc-programs-parallelizationopenmp-openmpvectornorm-cpp'),
              ('"Matrix-matrix '
               'multiplication":"https://github.com/CompPhysics/ComputationalPhysicsMSU/blob/master/doc/Programs/ParallelizationOpenMP/OpenMPmatrixmatrixmult.cpp"',
               2,
               None,
               'matrix-matrix-multiplication-https-github-com-compphysics-computationalphysicsmsu-blob-master-doc-programs-parallelizationopenmp-openmpmatrixmatrixmult-cpp')]}
end of tocinfo -->

<body>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
     equationNumbers: {  autoNumber: "none"  },
     extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js", "color.js"]
  }
});
</script>
<script type="text/javascript" async
 src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- Bootstrap navigation bar -->
<div class="navbar navbar-default navbar-fixed-top">
  <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="week9-bs.html">Week 11, March 11-15: Resampling Techniques, Bootstrap and Blocking</a>
  </div>
  <div class="navbar-collapse collapse navbar-responsive-collapse">
    <ul class="nav navbar-nav navbar-right">
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Contents <b class="caret"></b></a>
        <ul class="dropdown-menu">
     <!-- navigation toc: --> <li><a href="._week9-bs001.html#overview-of-week-11-march-11-15" style="font-size: 80%;">Overview of week 11, March 11-15</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs002.html#why-resampling-methods" style="font-size: 80%;">Why resampling methods ?</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs003.html#statistical-analysis" style="font-size: 80%;">Statistical analysis</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs004.html#and-why-do-we-use-such-methods" style="font-size: 80%;">And why do we use such methods?</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs005.html#central-limit-theorem" style="font-size: 80%;">Central limit theorem</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs006.html#further-remarks" style="font-size: 80%;">Further remarks</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs007.html#running-many-measurements" style="font-size: 80%;">Running many measurements</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs008.html#adding-more-definitions" style="font-size: 80%;">Adding more definitions</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs009.html#further-rewriting" style="font-size: 80%;">Further rewriting</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs010.html#the-covariance-term" style="font-size: 80%;">The covariance term</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs011.html#rewriting-the-covariance-term" style="font-size: 80%;">Rewriting the covariance term</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs012.html#introducing-the-correlation-function" style="font-size: 80%;">Introducing the correlation function</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs013.html#computing-the-correlation-function" style="font-size: 80%;">Computing the correlation function</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs014.html#resampling-methods-blocking" style="font-size: 80%;">Resampling methods: Blocking</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs015.html#why-blocking" style="font-size: 80%;">Why blocking?</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs018.html#blocking-transformations" style="font-size: 80%;">Blocking Transformations</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs018.html#blocking-transformations" style="font-size: 80%;">Blocking transformations</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs018.html#blocking-transformations" style="font-size: 80%;">Blocking Transformations</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs019.html#blocking-transformations-getting-there" style="font-size: 80%;">Blocking Transformations, getting there</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs020.html#blocking-transformations-final-expressions" style="font-size: 80%;">Blocking Transformations, final expressions</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs021.html#more-on-the-blocking-method" style="font-size: 80%;">More on the blocking method</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs022.html#example-code-form-last-week" style="font-size: 80%;">Example code form last week</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs023.html#resampling-analysis" style="font-size: 80%;">Resampling analysis</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs024.html#content" style="font-size: 80%;">Content</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs027.html#optimization-and-profiling" style="font-size: 80%;">Optimization and profiling</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs026.html#more-on-optimization" style="font-size: 80%;">More on optimization</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs027.html#optimization-and-profiling" style="font-size: 80%;">Optimization and profiling</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs028.html#optimization-and-debugging" style="font-size: 80%;">Optimization and debugging</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs029.html#other-hints" style="font-size: 80%;">Other hints</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs030.html#vectorization-and-the-basic-idea-behind-parallel-computing" style="font-size: 80%;">Vectorization and the basic idea behind parallel computing</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs031.html#a-rough-classification-of-hardware-models" style="font-size: 80%;">A rough classification of hardware models</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs032.html#shared-memory-and-distributed-memory" style="font-size: 80%;">Shared memory and distributed memory</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs034.html#different-parallel-programming-paradigms" style="font-size: 80%;">Different parallel programming paradigms</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs034.html#different-parallel-programming-paradigms" style="font-size: 80%;">Different parallel programming paradigms</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs035.html#what-is-vectorization" style="font-size: 80%;">What is vectorization?</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs036.html#number-of-elements-that-can-acted-upon" style="font-size: 80%;">Number of elements that can acted upon</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs039.html#number-of-elements-that-can-acted-upon-examples" style="font-size: 80%;">Number of elements that can acted upon, examples</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs038.html#operation-counts-for-scalar-operation" style="font-size: 80%;">Operation counts for scalar operation</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs039.html#number-of-elements-that-can-acted-upon-examples" style="font-size: 80%;">Number of elements that can acted upon, examples</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs040.html#number-of-operations-when-vectorized" style="font-size: 80%;">Number of operations when vectorized</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs041.html#a-simple-test-case-with-and-without-vectorization-https-github-com-compphysics-computationalphysicsmsu-blob-master-doc-programs-lectureprograms-programs-classes-cpp-program7-cpp" style="font-size: 80%;">"A simple test case with and without vectorization":"https://github.com/CompPhysics/ComputationalPhysicsMSU/blob/master/doc/Programs/LecturePrograms/programs/Classes/cpp/program7.cpp"</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs042.html#compiling-with-and-without-vectorization" style="font-size: 80%;">Compiling with and without vectorization</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs043.html#compiling-with-and-without-vectorization-using-clang" style="font-size: 80%;">Compiling with and without vectorization using clang</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs044.html#automatic-vectorization-and-vectorization-inhibitors-criteria" style="font-size: 80%;">Automatic vectorization and vectorization inhibitors, criteria</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs045.html#automatic-vectorization-and-vectorization-inhibitors-exit-criteria" style="font-size: 80%;">Automatic vectorization and vectorization inhibitors, exit criteria</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs046.html#automatic-vectorization-and-vectorization-inhibitors-straight-line-code" style="font-size: 80%;">Automatic vectorization and vectorization inhibitors, straight-line code</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs047.html#automatic-vectorization-and-vectorization-inhibitors-nested-loops" style="font-size: 80%;">Automatic vectorization and vectorization inhibitors, nested loops</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs048.html#automatic-vectorization-and-vectorization-inhibitors-function-calls" style="font-size: 80%;">Automatic vectorization and vectorization inhibitors, function calls</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs049.html#automatic-vectorization-and-vectorization-inhibitors-data-dependencies" style="font-size: 80%;">Automatic vectorization and vectorization inhibitors, data dependencies</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs050.html#automatic-vectorization-and-vectorization-inhibitors-more-data-dependencies" style="font-size: 80%;">Automatic vectorization and vectorization inhibitors, more data dependencies</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs051.html#automatic-vectorization-and-vectorization-inhibitors-memory-stride" style="font-size: 80%;">Automatic vectorization and vectorization inhibitors, memory stride</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs052.html#memory-management" style="font-size: 80%;">Memory management</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs053.html#memory-and-communication" style="font-size: 80%;">Memory and communication</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs054.html#measuring-performance" style="font-size: 80%;">Measuring performance</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs055.html#problems-with-measuring-time" style="font-size: 80%;">Problems with measuring time</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs056.html#problems-with-cold-start" style="font-size: 80%;">Problems with cold start</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs057.html#problems-with-smart-compilers" style="font-size: 80%;">Problems with smart compilers</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs058.html#problems-with-interference" style="font-size: 80%;">Problems with interference</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs059.html#problems-with-measuring-performance" style="font-size: 80%;">Problems with measuring performance</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs060.html#thomas-algorithm-for-tridiagonal-linear-algebra-equations" style="font-size: 80%;">Thomas algorithm for tridiagonal linear algebra equations</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs061.html#thomas-algorithm-forward-substitution" style="font-size: 80%;">Thomas algorithm, forward substitution</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs062.html#thomas-algorithm-backward-substitution" style="font-size: 80%;">Thomas algorithm, backward substitution</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs063.html#thomas-algorithm-and-counting-of-operations-floating-point-and-memory" style="font-size: 80%;">Thomas algorithm and counting of operations (floating point and memory)</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs064.html#example-transpose-of-a-matrix-https-github-com-compphysics-computationalphysicsmsu-blob-master-doc-programs-lectureprograms-programs-classes-cpp-program8-cpp" style="font-size: 80%;">"Example: Transpose of a matrix":"https://github.com/CompPhysics/ComputationalPhysicsMSU/blob/master/doc/Programs/LecturePrograms/programs/Classes/cpp/program8.cpp"</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs065.html#matrix-matrix-multiplication-https-github-com-compphysics-computationalphysicsmsu-blob-master-doc-programs-lectureprograms-programs-classes-cpp-program9-cpp" style="font-size: 80%;">"Matrix-matrix multiplication":"https://github.com/CompPhysics/ComputationalPhysicsMSU/blob/master/doc/Programs/LecturePrograms/programs/Classes/cpp/program9.cpp"</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs066.html#how-do-we-define-speedup-simplest-form" style="font-size: 80%;">How do we define speedup? Simplest form</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs067.html#how-do-we-define-speedup-correct-baseline" style="font-size: 80%;">How do we define speedup? Correct baseline</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs068.html#parallel-speedup" style="font-size: 80%;">Parallel  speedup</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs069.html#speedup-and-memory" style="font-size: 80%;">Speedup and memory</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs070.html#upper-bounds-on-speedup" style="font-size: 80%;">Upper bounds on speedup</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs071.html#amdahl-s-law" style="font-size: 80%;">Amdahl's law</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs072.html#how-much-is-parallelizable" style="font-size: 80%;">How much is parallelizable</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs073.html#today-s-situation-of-parallel-computing" style="font-size: 80%;">Today's situation of parallel computing</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs074.html#overhead-present-in-parallel-computing" style="font-size: 80%;">Overhead present in parallel computing</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs075.html#parallelizing-a-sequential-algorithm" style="font-size: 80%;">Parallelizing a sequential algorithm</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs076.html#strategies" style="font-size: 80%;">Strategies</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs077.html#how-do-i-run-mpi-on-a-pc-laptop-mpi" style="font-size: 80%;">How do I run MPI on a PC/Laptop? MPI</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs078.html#can-i-do-it-on-my-own-pc-laptop-openmp-installation" style="font-size: 80%;">Can I do it on my own PC/laptop? OpenMP installation</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs079.html#installing-mpi" style="font-size: 80%;">Installing MPI</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs080.html#installing-mpi-and-using-qt" style="font-size: 80%;">Installing MPI and using Qt</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs081.html#what-is-message-passing-interface-mpi" style="font-size: 80%;">What is Message Passing Interface (MPI)?</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs082.html#going-parallel-with-mpi" style="font-size: 80%;">Going Parallel with MPI</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs083.html#mpi-is-a-library" style="font-size: 80%;">MPI is a library</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs084.html#bindings-to-mpi-routines" style="font-size: 80%;">Bindings to MPI routines</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs085.html#communicator" style="font-size: 80%;">Communicator</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs086.html#some-of-the-most-important-mpi-functions" style="font-size: 80%;">Some of the most  important MPI functions</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs087.html#the-first-mpi-c-c-program-https-github-com-compphysics-computationalphysics2-blob-gh-pages-doc-programs-lectureprograms-programs-mpi-chapter07-program2-cpp" style="font-size: 80%;">"The first MPI C/C++ program":"https://github.com/CompPhysics/ComputationalPhysics2/blob/gh-pages/doc/Programs/LecturePrograms/programs/MPI/chapter07/program2.cpp"</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs088.html#the-fortran-program" style="font-size: 80%;">The Fortran program</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs089.html#note-1" style="font-size: 80%;">Note 1</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs090.html#ordered-output-with-mpibarrier-https-github-com-compphysics-computationalphysics2-blob-gh-pages-doc-programs-lectureprograms-programs-mpi-chapter07-program3-cpp" style="font-size: 80%;">"Ordered output with MPIBarrier":"https://github.com/CompPhysics/ComputationalPhysics2/blob/gh-pages/doc/Programs/LecturePrograms/programs/MPI/chapter07/program3.cpp"</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs091.html#note-2" style="font-size: 80%;">Note 2</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs092.html#ordered-output-https-github-com-compphysics-computationalphysics2-blob-gh-pages-doc-programs-lectureprograms-programs-mpi-chapter07-program4-cpp" style="font-size: 80%;">"Ordered output":"https://github.com/CompPhysics/ComputationalPhysics2/blob/gh-pages/doc/Programs/LecturePrograms/programs/MPI/chapter07/program4.cpp"</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs093.html#note-3" style="font-size: 80%;">Note 3</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs094.html#note-4" style="font-size: 80%;">Note 4</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs095.html#numerical-integration-in-parallel-https-github-com-compphysics-computationalphysics2-blob-gh-pages-doc-programs-lectureprograms-programs-mpi-chapter07-program6-cpp" style="font-size: 80%;">"Numerical integration in parallel":"https://github.com/CompPhysics/ComputationalPhysics2/blob/gh-pages/doc/Programs/LecturePrograms/programs/MPI/chapter07/program6.cpp"</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs096.html#dissection-of-trapezoidal-rule-with-mpi-reduce" style="font-size: 80%;">Dissection of trapezoidal rule with \( MPI\_reduce \)</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs102.html#dissection-of-trapezoidal-rule" style="font-size: 80%;">Dissection of trapezoidal rule</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs098.html#integrating-with-mpi" style="font-size: 80%;">Integrating with <b>MPI</b></a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs099.html#how-do-i-use-mpi-reduce" style="font-size: 80%;">How do I use \( MPI\_reduce \)?</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs100.html#more-on-mpi-reduce" style="font-size: 80%;">More on \( MPI\_Reduce \)</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs102.html#dissection-of-trapezoidal-rule" style="font-size: 80%;">Dissection of trapezoidal rule</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs102.html#dissection-of-trapezoidal-rule" style="font-size: 80%;">Dissection of trapezoidal rule</a></li>
     <!-- navigation toc: --> <li><a href="#the-quantum-dot-program-for-two-electrons-https-github-com-compphysics-computationalphysics2-blob-master-doc-programs-parallelizationmpi-mpivmcqdot-cpp" style="font-size: 80%;">"The quantum dot program for two electrons":"https://github.com/CompPhysics/ComputationalPhysics2/blob/master/doc/Programs/ParallelizationMPI/MPIvmcqdot.cpp"</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs104.html#what-is-openmp" style="font-size: 80%;">What is OpenMP</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs105.html#getting-started-things-to-remember" style="font-size: 80%;">Getting started, things to remember</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs106.html#openmp-syntax" style="font-size: 80%;">OpenMP syntax</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs107.html#different-openmp-styles-of-parallelism" style="font-size: 80%;">Different OpenMP styles of parallelism</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs108.html#general-code-structure" style="font-size: 80%;">General code structure</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs109.html#parallel-region" style="font-size: 80%;">Parallel region</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs110.html#hello-world-not-again-please" style="font-size: 80%;">Hello world, not again, please!</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs111.html#hello-world-yet-another-variant" style="font-size: 80%;">Hello world, yet another variant</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs112.html#important-openmp-library-routines" style="font-size: 80%;">Important OpenMP library routines</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs113.html#private-variables" style="font-size: 80%;">Private variables</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs114.html#master-region" style="font-size: 80%;">Master region</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs115.html#parallel-for-loop" style="font-size: 80%;">Parallel for loop</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs116.html#parallel-computations-and-loops" style="font-size: 80%;">Parallel computations and loops</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs117.html#scheduling-of-loop-computations" style="font-size: 80%;">Scheduling of  loop computations</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs118.html#example-code-for-loop-scheduling" style="font-size: 80%;">Example code for loop scheduling</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs119.html#example-code-for-loop-scheduling-guided-instead-of-dynamic" style="font-size: 80%;">Example code for loop scheduling, guided instead of dynamic</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs120.html#more-on-parallel-for-loop" style="font-size: 80%;">More on Parallel for loop</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs121.html#what-can-happen-with-this-loop" style="font-size: 80%;">What can happen with this loop?</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs122.html#inner-product" style="font-size: 80%;">Inner product</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs123.html#different-threads-do-different-tasks" style="font-size: 80%;">Different threads do different tasks</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs124.html#single-execution" style="font-size: 80%;">Single execution</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs125.html#coordination-and-synchronization" style="font-size: 80%;">Coordination and synchronization</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs126.html#data-scope" style="font-size: 80%;">Data scope</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs127.html#some-remarks" style="font-size: 80%;">Some remarks</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs128.html#parallelizing-nested-for-loops" style="font-size: 80%;">Parallelizing nested for-loops</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs129.html#nested-parallelism" style="font-size: 80%;">Nested parallelism</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs130.html#parallel-tasks" style="font-size: 80%;">Parallel tasks</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs131.html#common-mistakes" style="font-size: 80%;">Common mistakes</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs132.html#not-all-computations-are-simple" style="font-size: 80%;">Not all computations are simple</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs133.html#not-all-computations-are-simple-competing-threads" style="font-size: 80%;">Not all computations are simple, competing threads</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs134.html#how-to-find-the-max-value-using-openmp" style="font-size: 80%;">How to find the max value using OpenMP</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs135.html#then-deal-with-the-race-conditions" style="font-size: 80%;">Then deal with the race conditions</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs137.html#what-can-slow-down-openmp-performance" style="font-size: 80%;">What can slow down OpenMP performance?</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs137.html#what-can-slow-down-openmp-performance" style="font-size: 80%;">What can slow down OpenMP performance?</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs138.html#find-the-max-location-for-each-thread" style="font-size: 80%;">Find the max location for each thread</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs139.html#combine-the-values-from-each-thread" style="font-size: 80%;">Combine the values from each thread</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs140.html#matrix-matrix-multiplication-https-github-com-compphysics-computationalphysicsmsu-blob-master-doc-programs-parallelizationopenmp-openmpvectornorm-cpp" style="font-size: 80%;">"Matrix-matrix multiplication":"https://github.com/CompPhysics/ComputationalPhysicsMSU/blob/master/doc/Programs/ParallelizationOpenMP/OpenMPvectornorm.cpp"</a></li>
     <!-- navigation toc: --> <li><a href="._week9-bs141.html#matrix-matrix-multiplication-https-github-com-compphysics-computationalphysicsmsu-blob-master-doc-programs-parallelizationopenmp-openmpmatrixmatrixmult-cpp" style="font-size: 80%;">"Matrix-matrix multiplication":"https://github.com/CompPhysics/ComputationalPhysicsMSU/blob/master/doc/Programs/ParallelizationOpenMP/OpenMPmatrixmatrixmult.cpp"</a></li>

        </ul>
      </li>
    </ul>
  </div>
</div>
</div> <!-- end of navigation bar -->
<div class="container">
<p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p> <!-- add vertical space -->
<a name="part0103"></a>
<!-- !split -->
<h2 id="the-quantum-dot-program-for-two-electrons-https-github-com-compphysics-computationalphysics2-blob-master-doc-programs-parallelizationmpi-mpivmcqdot-cpp" class="anchor"><a href="https://github.com/CompPhysics/ComputationalPhysics2/blob/master/doc/Programs/ParallelizationMPI/MPIvmcqdot.cpp" target="_self">The quantum dot program for two electrons</a>  </h2>
<div class="panel panel-default">
<div class="panel-body">
<!-- subsequent paragraphs come in larger fonts, so start with a paragraph -->

<!-- code=c++ (!bc cppcod) typeset with pygments style "default" -->
<div class="cell border-box-sizing code_cell rendered">
  <div class="input">
    <div class="inner_cell">
      <div class="input_area">
        <div class="highlight" style="background: #f8f8f8">
  <pre style="line-height: 125%;"><span style="color: #408080; font-style: italic">// Variational Monte Carlo for atoms with importance sampling, slater det</span>
<span style="color: #408080; font-style: italic">// Test case for 2-electron quantum dot, no classes using Mersenne-Twister RNG</span>
<span style="color: #BC7A00">#include</span><span style="color: #bbbbbb"> </span><span style="color: #408080; font-style: italic">&quot;mpi.h&quot;</span><span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#include</span><span style="color: #bbbbbb"> </span><span style="color: #408080; font-style: italic">&lt;cmath&gt;</span><span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#include</span><span style="color: #bbbbbb"> </span><span style="color: #408080; font-style: italic">&lt;random&gt;</span><span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#include</span><span style="color: #bbbbbb"> </span><span style="color: #408080; font-style: italic">&lt;string&gt;</span><span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#include</span><span style="color: #bbbbbb"> </span><span style="color: #408080; font-style: italic">&lt;iostream&gt;</span><span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#include</span><span style="color: #bbbbbb"> </span><span style="color: #408080; font-style: italic">&lt;fstream&gt;</span><span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#include</span><span style="color: #bbbbbb"> </span><span style="color: #408080; font-style: italic">&lt;iomanip&gt;</span><span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#include</span><span style="color: #bbbbbb"> </span><span style="color: #408080; font-style: italic">&quot;vectormatrixclass.h&quot;</span><span style="color: #BC7A00"></span>

<span style="color: #008000; font-weight: bold">using</span><span style="color: #bbbbbb"> </span><span style="color: #008000; font-weight: bold">namespace</span><span style="color: #bbbbbb">  </span><span style="color: #0000FF; font-weight: bold">std</span>;<span style="color: #bbbbbb"></span>
<span style="color: #408080; font-style: italic">// output file as global variable</span>
ofstream<span style="color: #bbbbbb"> </span>ofile;<span style="color: #bbbbbb">  </span>
<span style="color: #408080; font-style: italic">// the step length and its squared inverse for the second derivative </span>
<span style="color: #408080; font-style: italic">//  Here we define global variables  used in various functions</span>
<span style="color: #408080; font-style: italic">//  These can be changed by using classes</span>
<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>Dimension<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">2</span>;<span style="color: #bbbbbb"> </span>
<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>NumberParticles<span style="color: #bbbbbb">  </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">2</span>;<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">//  we fix also the number of electrons to be 2</span>

<span style="color: #408080; font-style: italic">// declaration of functions </span>

<span style="color: #408080; font-style: italic">// The Mc sampling for the variational Monte Carlo </span>
<span style="color: #B00040">void</span><span style="color: #bbbbbb">  </span><span style="color: #0000FF">MonteCarloSampling</span>(<span style="color: #B00040">int</span>,<span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>,<span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>,<span style="color: #bbbbbb"> </span>Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>);<span style="color: #bbbbbb"></span>

<span style="color: #408080; font-style: italic">// The variational wave function</span>
<span style="color: #B00040">double</span><span style="color: #bbbbbb">  </span><span style="color: #0000FF">WaveFunction</span>(Matrix<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>,<span style="color: #bbbbbb"> </span>Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>);<span style="color: #bbbbbb"></span>

<span style="color: #408080; font-style: italic">// The local energy </span>
<span style="color: #B00040">double</span><span style="color: #bbbbbb">  </span><span style="color: #0000FF">LocalEnergy</span>(Matrix<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>,<span style="color: #bbbbbb"> </span>Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>);<span style="color: #bbbbbb"></span>

<span style="color: #408080; font-style: italic">// The quantum force</span>
<span style="color: #B00040">void</span><span style="color: #bbbbbb">  </span><span style="color: #0000FF">QuantumForce</span>(Matrix<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>,<span style="color: #bbbbbb"> </span>Matrix<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>,<span style="color: #bbbbbb"> </span>Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>);<span style="color: #bbbbbb"></span>


<span style="color: #408080; font-style: italic">// inline function for single-particle wave function</span>
<span style="color: #008000; font-weight: bold">inline</span><span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">SPwavefunction</span>(<span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>r,<span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>alpha)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">   </span><span style="color: #008000; font-weight: bold">return</span><span style="color: #bbbbbb"> </span>exp(<span style="color: #666666">-</span>alpha<span style="color: #666666">*</span>r<span style="color: #666666">*0.5</span>);<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb"></span>

<span style="color: #408080; font-style: italic">// inline function for derivative of single-particle wave function</span>
<span style="color: #008000; font-weight: bold">inline</span><span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">DerivativeSPwavefunction</span>(<span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>r,<span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>alpha)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">return</span><span style="color: #bbbbbb"> </span><span style="color: #666666">-</span>r<span style="color: #666666">*</span>alpha;<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb"></span>

<span style="color: #408080; font-style: italic">// function for absolute value of relative distance</span>
<span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">RelativeDistance</span>(Matrix<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>r,<span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>i,<span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>j)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">      </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>r_ij<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb">  </span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>k<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>k<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>Dimension;<span style="color: #bbbbbb"> </span>k<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">	</span>r_ij<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span>(r(i,k)<span style="color: #666666">-</span>r(j,k))<span style="color: #666666">*</span>(r(i,k)<span style="color: #666666">-</span>r(j,k));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">return</span><span style="color: #bbbbbb"> </span>sqrt(r_ij);<span style="color: #bbbbbb"> </span>
}<span style="color: #bbbbbb"></span>

<span style="color: #408080; font-style: italic">// inline function for derivative of Jastrow factor</span>
<span style="color: #008000; font-weight: bold">inline</span><span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">JastrowDerivative</span>(Matrix<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>r,<span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>beta,<span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>i,<span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>j,<span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>k){<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">return</span><span style="color: #bbbbbb"> </span>(r(i,k)<span style="color: #666666">-</span>r(j,k))<span style="color: #666666">/</span>(RelativeDistance(r,<span style="color: #bbbbbb"> </span>i,<span style="color: #bbbbbb"> </span>j)<span style="color: #666666">*</span>pow(<span style="color: #666666">1.0+</span>beta<span style="color: #666666">*</span>RelativeDistance(r,<span style="color: #bbbbbb"> </span>i,<span style="color: #bbbbbb"> </span>j),<span style="color: #666666">2</span>));<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb"></span>

<span style="color: #408080; font-style: italic">// function for square of position of single particle</span>
<span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">singleparticle_pos2</span>(Matrix<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>r,<span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>i)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">    </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>r_single_particle<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>Dimension;<span style="color: #bbbbbb"> </span>j<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">      </span>r_single_particle<span style="color: #bbbbbb">  </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span>r(i,j)<span style="color: #666666">*</span>r(i,j);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">return</span><span style="color: #bbbbbb"> </span>r_single_particle;<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb"></span>

<span style="color: #B00040">void</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">lnsrch</span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>n,<span style="color: #bbbbbb"> </span>Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>xold,<span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>fold,<span style="color: #bbbbbb"> </span>Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>g,<span style="color: #bbbbbb"> </span>Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>p,<span style="color: #bbbbbb"> </span>Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>x,<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">		 </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span><span style="color: #666666">*</span>f,<span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>stpmax,<span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span><span style="color: #666666">*</span>check,<span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>(<span style="color: #666666">*</span>func)(Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>p));<span style="color: #bbbbbb"></span>

<span style="color: #B00040">void</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">dfpmin</span>(Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>p,<span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>n,<span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>gtol,<span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span><span style="color: #666666">*</span>iter,<span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span><span style="color: #666666">*</span>fret,<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	    </span><span style="color: #B00040">double</span>(<span style="color: #666666">*</span>func)(Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>p),<span style="color: #bbbbbb"> </span><span style="color: #B00040">void</span><span style="color: #bbbbbb"> </span>(<span style="color: #666666">*</span>dfunc)(Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>p,<span style="color: #bbbbbb"> </span>Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>g));<span style="color: #bbbbbb"></span>

<span style="color: #008000; font-weight: bold">static</span><span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>sqrarg;<span style="color: #bbbbbb"></span>
<span style="color: #BC7A00">#define SQR(a) ((sqrarg=(a)) == 0.0 ? 0.0 : sqrarg*sqrarg)</span>


<span style="color: #008000; font-weight: bold">static</span><span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>maxarg1,maxarg2;<span style="color: #bbbbbb"></span>
<span style="color: #BC7A00">#define FMAX(a,b) (maxarg1=(a),maxarg2=(b),(maxarg1) &gt; (maxarg2) ?\</span>
<span style="color: #BC7A00">        (maxarg1) : (maxarg2))</span>


<span style="color: #408080; font-style: italic">// Begin of main program   </span>

<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">main</span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>argc,<span style="color: #bbbbbb"> </span><span style="color: #B00040">char</span><span style="color: #666666">*</span><span style="color: #bbbbbb"> </span>argv[])<span style="color: #bbbbbb"></span>
{<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">//  MPI initializations</span>
<span style="color: #bbbbbb">  </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>NumberProcesses,<span style="color: #bbbbbb"> </span>MyRank,<span style="color: #bbbbbb"> </span>NumberMCsamples;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>MPI_Init<span style="color: #bbbbbb"> </span>(<span style="color: #666666">&amp;</span>argc,<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>argv);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>MPI_Comm_size<span style="color: #bbbbbb"> </span>(MPI_COMM_WORLD,<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>NumberProcesses);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>MPI_Comm_rank<span style="color: #bbbbbb"> </span>(MPI_COMM_WORLD,<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>MyRank);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>StartTime<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>MPI_Wtime();<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(MyRank<span style="color: #bbbbbb"> </span><span style="color: #666666">==</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span><span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;&amp;</span><span style="color: #bbbbbb"> </span>argc<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">1</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>cout<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;Bad Usage: &quot;</span><span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>argv[<span style="color: #666666">0</span>]<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">      </span><span style="color: #BA2121">&quot; Read also output file on same line and number of Monte Carlo cycles&quot;</span><span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>endl;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// Read filename and number of Monte Carlo cycles from the command line</span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(MyRank<span style="color: #bbbbbb"> </span><span style="color: #666666">==</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span><span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;&amp;</span><span style="color: #bbbbbb"> </span>argc<span style="color: #bbbbbb"> </span><span style="color: #666666">&gt;</span><span style="color: #bbbbbb"> </span><span style="color: #666666">2</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>string<span style="color: #bbbbbb"> </span>filename<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>argv[<span style="color: #666666">1</span>];<span style="color: #bbbbbb"> </span><span style="color: #408080; font-style: italic">// first command line argument after name of program</span>
<span style="color: #bbbbbb">    </span>NumberMCsamples<span style="color: #bbbbbb">  </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>atoi(argv[<span style="color: #666666">2</span>]);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>string<span style="color: #bbbbbb"> </span>fileout<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>filename;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>string<span style="color: #bbbbbb"> </span>argument<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>to_string(NumberMCsamples);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #408080; font-style: italic">// Final filename as filename+NumberMCsamples</span>
<span style="color: #bbbbbb">    </span>fileout.append(argument);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>ofile.open(fileout);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// broadcast the number of  Monte Carlo samples</span>
<span style="color: #bbbbbb">  </span>MPI_Bcast<span style="color: #bbbbbb"> </span>(<span style="color: #666666">&amp;</span>NumberMCsamples,<span style="color: #bbbbbb"> </span><span style="color: #666666">1</span>,<span style="color: #bbbbbb"> </span>MPI_INT,<span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>,<span style="color: #bbbbbb"> </span>MPI_COMM_WORLD);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// Two variational parameters only</span>
<span style="color: #bbbbbb">  </span>Vector<span style="color: #bbbbbb"> </span>VariationalParameters(<span style="color: #666666">2</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>TotalNumberMCsamples<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>NumberMCsamples<span style="color: #666666">*</span>NumberProcesses;<span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// Loop over variational parameters</span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>alpha<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0.5</span>;<span style="color: #bbbbbb"> </span>alpha<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">1.5</span>;<span style="color: #bbbbbb"> </span>alpha<span style="color: #bbbbbb"> </span><span style="color: #666666">+=0.1</span>){<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>beta<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0.1</span>;<span style="color: #bbbbbb"> </span>beta<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0.5</span>;<span style="color: #bbbbbb"> </span>beta<span style="color: #bbbbbb"> </span><span style="color: #666666">+=0.05</span>){<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>VariationalParameters(<span style="color: #666666">0</span>)<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>alpha;<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// value of alpha</span>
<span style="color: #bbbbbb">      </span>VariationalParameters(<span style="color: #666666">1</span>)<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>beta;<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// value of beta</span>
<span style="color: #bbbbbb">      </span><span style="color: #408080; font-style: italic">//  Do the mc sampling  and accumulate data with MPI_Reduce</span>
<span style="color: #bbbbbb">      </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>TotalEnergy,<span style="color: #bbbbbb"> </span>TotalEnergySquared,<span style="color: #bbbbbb"> </span>LocalProcessEnergy,<span style="color: #bbbbbb"> </span>LocalProcessEnergy2;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>LocalProcessEnergy<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>LocalProcessEnergy2<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0.0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>MonteCarloSampling(NumberMCsamples,<span style="color: #bbbbbb"> </span>LocalProcessEnergy,<span style="color: #bbbbbb"> </span>LocalProcessEnergy2,<span style="color: #bbbbbb"> </span>VariationalParameters);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #408080; font-style: italic">//  Collect data in total averages</span>
<span style="color: #bbbbbb">      </span>MPI_Reduce(<span style="color: #666666">&amp;</span>LocalProcessEnergy,<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>TotalEnergy,<span style="color: #bbbbbb"> </span><span style="color: #666666">1</span>,<span style="color: #bbbbbb"> </span>MPI_DOUBLE,<span style="color: #bbbbbb"> </span>MPI_SUM,<span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>,<span style="color: #bbbbbb"> </span>MPI_COMM_WORLD);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>MPI_Reduce(<span style="color: #666666">&amp;</span>LocalProcessEnergy2,<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>TotalEnergySquared,<span style="color: #bbbbbb"> </span><span style="color: #666666">1</span>,<span style="color: #bbbbbb"> </span>MPI_DOUBLE,<span style="color: #bbbbbb"> </span>MPI_SUM,<span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>,<span style="color: #bbbbbb"> </span>MPI_COMM_WORLD);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #408080; font-style: italic">// Print out results  in case of Master node, set to MyRank = 0</span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(<span style="color: #bbbbbb"> </span>MyRank<span style="color: #bbbbbb"> </span><span style="color: #666666">==</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>Energy<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>TotalEnergy<span style="color: #666666">/</span>(<span style="color: #bbbbbb"> </span>(<span style="color: #B00040">double</span>)NumberProcesses);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>Variance<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>TotalEnergySquared<span style="color: #666666">/</span>(<span style="color: #bbbbbb"> </span>(<span style="color: #B00040">double</span>)NumberProcesses)<span style="color: #666666">-</span>Energy<span style="color: #666666">*</span>Energy;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>StandardDeviation<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>sqrt(Variance<span style="color: #666666">/</span>((<span style="color: #B00040">double</span>)TotalNumberMCsamples));<span style="color: #bbbbbb"> </span><span style="color: #408080; font-style: italic">// over optimistic error</span>
<span style="color: #bbbbbb">	</span>ofile<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>setiosflags(ios<span style="color: #666666">::</span>showpoint<span style="color: #bbbbbb"> </span><span style="color: #666666">|</span><span style="color: #bbbbbb"> </span>ios<span style="color: #666666">::</span>uppercase);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span>ofile<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>setw(<span style="color: #666666">15</span>)<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>setprecision(<span style="color: #666666">8</span>)<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>VariationalParameters(<span style="color: #666666">0</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span>ofile<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>setw(<span style="color: #666666">15</span>)<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>setprecision(<span style="color: #666666">8</span>)<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>VariationalParameters(<span style="color: #666666">1</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span>ofile<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>setw(<span style="color: #666666">15</span>)<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>setprecision(<span style="color: #666666">8</span>)<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>Energy;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span>ofile<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>setw(<span style="color: #666666">15</span>)<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>setprecision(<span style="color: #666666">8</span>)<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>Variance;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span>ofile<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>setw(<span style="color: #666666">15</span>)<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>setprecision(<span style="color: #666666">8</span>)<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>StandardDeviation<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>endl;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>EndTime<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>MPI_Wtime();<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>TotalTime<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>EndTime<span style="color: #666666">-</span>StartTime;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(<span style="color: #bbbbbb"> </span>MyRank<span style="color: #bbbbbb"> </span><span style="color: #666666">==</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span><span style="color: #bbbbbb"> </span>)<span style="color: #bbbbbb">  </span>cout<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;Time = &quot;</span><span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb">  </span>TotalTime<span style="color: #bbbbbb">  </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot; on number of processors: &quot;</span><span style="color: #bbbbbb">  </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>NumberProcesses<span style="color: #bbbbbb">  </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>endl;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(MyRank<span style="color: #bbbbbb"> </span><span style="color: #666666">==</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>)<span style="color: #bbbbbb">  </span>ofile.close();<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// close output file</span>
<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// End MPI</span>
<span style="color: #bbbbbb">  </span>MPI_Finalize<span style="color: #bbbbbb"> </span>();<span style="color: #bbbbbb">  </span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">return</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">//  end of main function</span>


<span style="color: #408080; font-style: italic">// Monte Carlo sampling with the Metropolis algorithm  </span>

<span style="color: #B00040">void</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">MonteCarloSampling</span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>NumberMCsamples,<span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>cumulative_e,<span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>cumulative_e2,<span style="color: #bbbbbb"> </span>Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>VariationalParameters)<span style="color: #bbbbbb"></span>
{<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb"> </span><span style="color: #408080; font-style: italic">// Initialize the seed and call the Mersienne algo</span>
<span style="color: #bbbbbb">  </span>std<span style="color: #666666">::</span>random_device<span style="color: #bbbbbb"> </span>rd;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>std<span style="color: #666666">::</span>mt19937_64<span style="color: #bbbbbb"> </span>gen(rd());<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// Set up the uniform distribution for x \in [[0, 1]</span>
<span style="color: #bbbbbb">  </span>std<span style="color: #666666">::</span>uniform_real_distribution<span style="color: #666666">&lt;</span><span style="color: #B00040">double</span><span style="color: #666666">&gt;</span><span style="color: #bbbbbb"> </span>UniformNumberGenerator(<span style="color: #666666">0.0</span>,<span style="color: #666666">1.0</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>std<span style="color: #666666">::</span>normal_distribution<span style="color: #666666">&lt;</span><span style="color: #B00040">double</span><span style="color: #666666">&gt;</span><span style="color: #bbbbbb"> </span>Normaldistribution(<span style="color: #666666">0.0</span>,<span style="color: #666666">1.0</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// diffusion constant from Schroedinger equation</span>
<span style="color: #bbbbbb">  </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>D<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0.5</span>;<span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">  </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>timestep<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0.05</span>;<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">//  we fix the time step  for the gaussian deviate</span>
<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// allocate matrices which contain the position of the particles  </span>
<span style="color: #bbbbbb">  </span>Matrix<span style="color: #bbbbbb"> </span>OldPosition(<span style="color: #bbbbbb"> </span>NumberParticles,<span style="color: #bbbbbb"> </span>Dimension),<span style="color: #bbbbbb"> </span>NewPosition(<span style="color: #bbbbbb"> </span>NumberParticles,<span style="color: #bbbbbb"> </span>Dimension);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>Matrix<span style="color: #bbbbbb"> </span>OldQuantumForce(NumberParticles,<span style="color: #bbbbbb"> </span>Dimension),<span style="color: #bbbbbb"> </span>NewQuantumForce(NumberParticles,<span style="color: #bbbbbb"> </span>Dimension);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>Energy<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0.0</span>;<span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>EnergySquared<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0.0</span>;<span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>DeltaE<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0.0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">//  initial trial positions</span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>i<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>i<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>NumberParticles;<span style="color: #bbbbbb"> </span>i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>Dimension;<span style="color: #bbbbbb"> </span>j<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>OldPosition(i,j)<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>Normaldistribution(gen)<span style="color: #666666">*</span>sqrt(timestep);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>OldWaveFunction<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>WaveFunction(OldPosition,<span style="color: #bbbbbb"> </span>VariationalParameters);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>QuantumForce(OldPosition,<span style="color: #bbbbbb"> </span>OldQuantumForce,<span style="color: #bbbbbb"> </span>VariationalParameters);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// loop over monte carlo cycles </span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>cycles<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">1</span>;<span style="color: #bbbbbb"> </span>cycles<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;=</span><span style="color: #bbbbbb"> </span>NumberMCsamples;<span style="color: #bbbbbb"> </span>cycles<span style="color: #666666">++</span>){<span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">    </span><span style="color: #408080; font-style: italic">// new position </span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>i<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>i<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>NumberParticles;<span style="color: #bbbbbb"> </span>i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>Dimension;<span style="color: #bbbbbb"> </span>j<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span><span style="color: #408080; font-style: italic">// gaussian deviate to compute new positions using a given timestep</span>
<span style="color: #bbbbbb">	</span>NewPosition(i,j)<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>OldPosition(i,j)<span style="color: #bbbbbb"> </span><span style="color: #666666">+</span><span style="color: #bbbbbb"> </span>Normaldistribution(gen)<span style="color: #666666">*</span>sqrt(timestep)<span style="color: #666666">+</span>OldQuantumForce(i,j)<span style="color: #666666">*</span>timestep<span style="color: #666666">*</span>D;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span><span style="color: #408080; font-style: italic">//	NewPosition(i,j) = OldPosition(i,j) + gaussian_deviate(&amp;idum)*sqrt(timestep)+OldQuantumForce(i,j)*timestep*D;</span>
<span style="color: #bbbbbb">      </span>}<span style="color: #bbbbbb">  </span>
<span style="color: #bbbbbb">      </span><span style="color: #408080; font-style: italic">//  for the other particles we need to set the position to the old position since</span>
<span style="color: #bbbbbb">      </span><span style="color: #408080; font-style: italic">//  we move only one particle at the time</span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>k<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>k<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>NumberParticles;<span style="color: #bbbbbb"> </span>k<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(<span style="color: #bbbbbb"> </span>k<span style="color: #bbbbbb"> </span><span style="color: #666666">!=</span><span style="color: #bbbbbb"> </span>i)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	  </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>Dimension;<span style="color: #bbbbbb"> </span>j<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	    </span>NewPosition(k,j)<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>OldPosition(k,j);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	  </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span>}<span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">      </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>NewWaveFunction<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>WaveFunction(NewPosition,<span style="color: #bbbbbb"> </span>VariationalParameters);<span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">      </span>QuantumForce(NewPosition,<span style="color: #bbbbbb"> </span>NewQuantumForce,<span style="color: #bbbbbb"> </span>VariationalParameters);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #408080; font-style: italic">//  we compute the log of the ratio of the greens functions to be used in the </span>
<span style="color: #bbbbbb">      </span><span style="color: #408080; font-style: italic">//  Metropolis-Hastings algorithm</span>
<span style="color: #bbbbbb">      </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>GreensFunction<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0.0</span>;<span style="color: #bbbbbb">            </span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>Dimension;<span style="color: #bbbbbb"> </span>j<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span>GreensFunction<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0.5*</span>(OldQuantumForce(i,j)<span style="color: #666666">+</span>NewQuantumForce(i,j))<span style="color: #666666">*</span><span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	  </span>(D<span style="color: #666666">*</span>timestep<span style="color: #666666">*0.5*</span>(OldQuantumForce(i,j)<span style="color: #666666">-</span>NewQuantumForce(i,j))<span style="color: #666666">-</span>NewPosition(i,j)<span style="color: #666666">+</span>OldPosition(i,j));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>GreensFunction<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>exp(GreensFunction);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #408080; font-style: italic">// The Metropolis test is performed by moving one particle at the time</span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">if</span>(UniformNumberGenerator(gen)<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;=</span><span style="color: #bbbbbb"> </span>GreensFunction<span style="color: #666666">*</span>NewWaveFunction<span style="color: #666666">*</span>NewWaveFunction<span style="color: #666666">/</span>OldWaveFunction<span style="color: #666666">/</span>OldWaveFunction<span style="color: #bbbbbb"> </span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">	</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb">  </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>Dimension;<span style="color: #bbbbbb"> </span>j<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	  </span>OldPosition(i,j)<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>NewPosition(i,j);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	  </span>OldQuantumForce(i,j)<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>NewQuantumForce(i,j);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span>OldWaveFunction<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>NewWaveFunction;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">//  end of loop over particles</span>
<span style="color: #bbbbbb">    </span><span style="color: #408080; font-style: italic">// compute local energy  </span>
<span style="color: #bbbbbb">    </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>DeltaE<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>LocalEnergy(OldPosition,<span style="color: #bbbbbb"> </span>VariationalParameters);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #408080; font-style: italic">// update energies</span>
<span style="color: #bbbbbb">    </span>Energy<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span>DeltaE;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>EnergySquared<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span>DeltaE<span style="color: #666666">*</span>DeltaE;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb">   </span><span style="color: #408080; font-style: italic">// end of loop over MC trials   </span>
<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// update the energy average and its squared </span>
<span style="color: #bbbbbb">  </span>cumulative_e<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>Energy<span style="color: #666666">/</span>NumberMCsamples;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>cumulative_e2<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>EnergySquared<span style="color: #666666">/</span>NumberMCsamples;<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb">   </span><span style="color: #408080; font-style: italic">// end MonteCarloSampling function  </span>


<span style="color: #408080; font-style: italic">// Function to compute the squared wave function and the quantum force</span>

<span style="color: #B00040">double</span><span style="color: #bbbbbb">  </span><span style="color: #0000FF">WaveFunction</span>(Matrix<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>r,<span style="color: #bbbbbb"> </span>Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>VariationalParameters)<span style="color: #bbbbbb"></span>
{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>wf<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0.0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// full Slater determinant for two particles, replace with Slater det for more particles </span>
<span style="color: #bbbbbb">  </span>wf<span style="color: #bbbbbb">  </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>SPwavefunction(singleparticle_pos2(r,<span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>),<span style="color: #bbbbbb"> </span>VariationalParameters(<span style="color: #666666">0</span>))<span style="color: #666666">*</span>SPwavefunction(singleparticle_pos2(r,<span style="color: #bbbbbb"> </span><span style="color: #666666">1</span>),VariationalParameters(<span style="color: #666666">0</span>));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// contribution from Jastrow factor</span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>i<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>i<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>NumberParticles<span style="color: #666666">-1</span>;<span style="color: #bbbbbb"> </span>i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>i<span style="color: #666666">+1</span>;<span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>NumberParticles;<span style="color: #bbbbbb"> </span>j<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>wf<span style="color: #bbbbbb"> </span><span style="color: #666666">*=</span><span style="color: #bbbbbb"> </span>exp(RelativeDistance(r,<span style="color: #bbbbbb"> </span>i,<span style="color: #bbbbbb"> </span>j)<span style="color: #666666">/</span>((<span style="color: #666666">1.0+</span>VariationalParameters(<span style="color: #666666">1</span>)<span style="color: #666666">*</span>RelativeDistance(r,<span style="color: #bbbbbb"> </span>i,<span style="color: #bbbbbb"> </span>j))));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">return</span><span style="color: #bbbbbb"> </span>wf;<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb"></span>

<span style="color: #408080; font-style: italic">// Function to calculate the local energy without numerical derivation of kinetic energy</span>

<span style="color: #B00040">double</span><span style="color: #bbbbbb">  </span><span style="color: #0000FF">LocalEnergy</span>(Matrix<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>r,<span style="color: #bbbbbb"> </span>Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>VariationalParameters)<span style="color: #bbbbbb"></span>
{<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// compute the kinetic and potential energy from the single-particle part</span>
<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// for a many-electron system this has to be replaced by a Slater determinant</span>
<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// The absolute value of the interparticle length</span>
<span style="color: #bbbbbb">  </span>Matrix<span style="color: #bbbbbb"> </span>length(<span style="color: #bbbbbb"> </span>NumberParticles,<span style="color: #bbbbbb"> </span>NumberParticles);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// Set up interparticle distance</span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>i<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>i<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>NumberParticles<span style="color: #666666">-1</span>;<span style="color: #bbbbbb"> </span>i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>i<span style="color: #666666">+1</span>;<span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>NumberParticles;<span style="color: #bbbbbb"> </span>j<span style="color: #666666">++</span>){<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>length(i,j)<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>RelativeDistance(r,<span style="color: #bbbbbb"> </span>i,<span style="color: #bbbbbb"> </span>j);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>length(j,i)<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb">  </span>length(i,j);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>KineticEnergy<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0.0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// Set up kinetic energy from Slater and Jastrow terms</span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>i<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>i<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>NumberParticles;<span style="color: #bbbbbb"> </span>i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>k<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>k<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>Dimension;<span style="color: #bbbbbb"> </span>k<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>sum1<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0.0</span>;<span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">for</span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>NumberParticles;<span style="color: #bbbbbb"> </span>j<span style="color: #666666">++</span>){<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(<span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">!=</span><span style="color: #bbbbbb"> </span>i)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	  </span>sum1<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span>JastrowDerivative(r,<span style="color: #bbbbbb"> </span>VariationalParameters(<span style="color: #666666">1</span>),<span style="color: #bbbbbb"> </span>i,<span style="color: #bbbbbb"> </span>j,<span style="color: #bbbbbb"> </span>k);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>KineticEnergy<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span>(sum1<span style="color: #666666">+</span>DerivativeSPwavefunction(r(i,k),VariationalParameters(<span style="color: #666666">0</span>)))<span style="color: #666666">*</span>(sum1<span style="color: #666666">+</span>DerivativeSPwavefunction(r(i,k),VariationalParameters(<span style="color: #666666">0</span>)));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>KineticEnergy<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">-2*</span>VariationalParameters(<span style="color: #666666">0</span>)<span style="color: #666666">*</span>NumberParticles;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>i<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>i<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>NumberParticles<span style="color: #666666">-1</span>;<span style="color: #bbbbbb"> </span>i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>i<span style="color: #666666">+1</span>;<span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>NumberParticles;<span style="color: #bbbbbb"> </span>j<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span>KineticEnergy<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">2.0/</span>(pow(<span style="color: #666666">1.0</span><span style="color: #bbbbbb"> </span><span style="color: #666666">+</span><span style="color: #bbbbbb"> </span>VariationalParameters(<span style="color: #666666">1</span>)<span style="color: #666666">*</span>length(i,j),<span style="color: #666666">2</span>))<span style="color: #666666">*</span>(<span style="color: #666666">1.0/</span>length(i,j)<span style="color: #666666">-2*</span>VariationalParameters(<span style="color: #666666">1</span>)<span style="color: #666666">/</span>(<span style="color: #666666">1+</span>VariationalParameters(<span style="color: #666666">1</span>)<span style="color: #666666">*</span>length(i,j))<span style="color: #bbbbbb"> </span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>KineticEnergy<span style="color: #bbbbbb"> </span><span style="color: #666666">*=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">-0.5</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// Set up potential energy, external potential + eventual electron-electron repulsion</span>
<span style="color: #bbbbbb">  </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>PotentialEnergy<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>i<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>i<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>NumberParticles;<span style="color: #bbbbbb"> </span>i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">    </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>DistanceSquared<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>singleparticle_pos2(r,<span style="color: #bbbbbb"> </span>i);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>PotentialEnergy<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0.5*</span>DistanceSquared;<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// sp energy HO part, note it has the oscillator frequency set to 1!</span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// Add the electron-electron repulsion</span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>i<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>i<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>NumberParticles<span style="color: #666666">-1</span>;<span style="color: #bbbbbb"> </span>i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"> </span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>i<span style="color: #666666">+1</span>;<span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>NumberParticles;<span style="color: #bbbbbb"> </span>j<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>PotentialEnergy<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">1.0/</span>length(i,j);<span style="color: #bbbbbb">          </span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>LocalE<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>KineticEnergy<span style="color: #666666">+</span>PotentialEnergy;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">return</span><span style="color: #bbbbbb"> </span>LocalE;<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb"></span>

<span style="color: #408080; font-style: italic">// Compute the analytical expression for the quantum force</span>
<span style="color: #B00040">void</span><span style="color: #bbbbbb">  </span><span style="color: #0000FF">QuantumForce</span>(Matrix<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>r,<span style="color: #bbbbbb"> </span>Matrix<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>qforce,<span style="color: #bbbbbb"> </span>Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>VariationalParameters)<span style="color: #bbbbbb"></span>
{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #408080; font-style: italic">// compute the first derivative </span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>i<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>i<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>NumberParticles;<span style="color: #bbbbbb"> </span>i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>k<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>k<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>Dimension;<span style="color: #bbbbbb"> </span>k<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #408080; font-style: italic">// single-particle part, replace with Slater det for larger systems</span>
<span style="color: #bbbbbb">      </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>sppart<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>DerivativeSPwavefunction(r(i,k),VariationalParameters(<span style="color: #666666">0</span>));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #408080; font-style: italic">//  Jastrow factor contribution</span>
<span style="color: #bbbbbb">      </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>Jsum<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0.0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>NumberParticles;<span style="color: #bbbbbb"> </span>j<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(<span style="color: #bbbbbb"> </span>j<span style="color: #bbbbbb"> </span><span style="color: #666666">!=</span><span style="color: #bbbbbb"> </span>i)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	  </span>Jsum<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span>JastrowDerivative(r,<span style="color: #bbbbbb"> </span>VariationalParameters(<span style="color: #666666">1</span>),<span style="color: #bbbbbb"> </span>i,<span style="color: #bbbbbb"> </span>j,<span style="color: #bbbbbb"> </span>k);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>qforce(i,k)<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">2.0*</span>(Jsum<span style="color: #666666">+</span>sppart);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb"> </span><span style="color: #408080; font-style: italic">// end of QuantumForce function</span>


<span style="color: #BC7A00">#define ITMAX 200</span>
<span style="color: #BC7A00">#define EPS 3.0e-8</span>
<span style="color: #BC7A00">#define TOLX (4*EPS)</span>
<span style="color: #BC7A00">#define STPMX 100.0</span>

<span style="color: #B00040">void</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">dfpmin</span>(Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>p,<span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>n,<span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>gtol,<span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span><span style="color: #666666">*</span>iter,<span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span><span style="color: #666666">*</span>fret,<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	    </span><span style="color: #B00040">double</span>(<span style="color: #666666">*</span>func)(Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>p),<span style="color: #bbbbbb"> </span><span style="color: #B00040">void</span><span style="color: #bbbbbb"> </span>(<span style="color: #666666">*</span>dfunc)(Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>p,<span style="color: #bbbbbb"> </span>Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>g))<span style="color: #bbbbbb"></span>
{<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>check,i,its,j;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>den,fac,fad,fae,fp,stpmax,sum<span style="color: #666666">=0.0</span>,sumdg,sumxi,temp,test;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>Vector<span style="color: #bbbbbb"> </span>dg(n),<span style="color: #bbbbbb"> </span>g(n),<span style="color: #bbbbbb"> </span>hdg(n),<span style="color: #bbbbbb"> </span>pnew(n),<span style="color: #bbbbbb"> </span>xi(n);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>Matrix<span style="color: #bbbbbb"> </span>hessian(n,n);<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span>fp<span style="color: #666666">=</span>(<span style="color: #666666">*</span>func)(p);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>(<span style="color: #666666">*</span>dfunc)(p,g);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(i<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;i<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>n;i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(j<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>j<span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>n;j<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>hessian(i,j)<span style="color: #666666">=0.0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>hessian(i,i)<span style="color: #666666">=1.0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>xi(i)<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">-</span>g(i);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>sum<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span>p(i)<span style="color: #666666">*</span>p(i);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>stpmax<span style="color: #666666">=</span>STPMX<span style="color: #666666">*</span>FMAX(sqrt(sum),(<span style="color: #B00040">double</span>)n);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(its<span style="color: #666666">=1</span>;its<span style="color: #666666">&lt;=</span>ITMAX;its<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #666666">*</span>iter<span style="color: #666666">=</span>its;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>lnsrch(n,p,fp,g,xi,pnew,fret,stpmax,<span style="color: #666666">&amp;</span>check,func);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>fp<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">*</span>fret;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(i<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>i<span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>n;i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>xi(i)<span style="color: #666666">=</span>pnew(i)<span style="color: #666666">-</span>p(i);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>p(i)<span style="color: #666666">=</span>pnew(i);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>test<span style="color: #666666">=0.0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(i<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;i<span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>n;i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>temp<span style="color: #666666">=</span>fabs(xi(i))<span style="color: #666666">/</span>FMAX(fabs(p(i)),<span style="color: #666666">1.0</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(temp<span style="color: #bbbbbb"> </span><span style="color: #666666">&gt;</span><span style="color: #bbbbbb"> </span>test)<span style="color: #bbbbbb"> </span>test<span style="color: #666666">=</span>temp;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(test<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>TOLX)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">return</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(i<span style="color: #666666">=0</span>;i<span style="color: #666666">&lt;</span>n;i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>dg(i)<span style="color: #666666">=</span>g(i);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>(<span style="color: #666666">*</span>dfunc)(p,g);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>test<span style="color: #666666">=0.0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>den<span style="color: #666666">=</span>FMAX(<span style="color: #666666">*</span>fret,<span style="color: #666666">1.0</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(i<span style="color: #666666">=0</span>;i<span style="color: #666666">&lt;</span>n;i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>temp<span style="color: #666666">=</span>fabs(g(i))<span style="color: #666666">*</span>FMAX(fabs(p(i)),<span style="color: #666666">1.0</span>)<span style="color: #666666">/</span>den;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(temp<span style="color: #bbbbbb"> </span><span style="color: #666666">&gt;</span><span style="color: #bbbbbb"> </span>test)<span style="color: #bbbbbb"> </span>test<span style="color: #666666">=</span>temp;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(test<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>gtol)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">return</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(i<span style="color: #666666">=0</span>;i<span style="color: #666666">&lt;</span>n;i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>dg(i)<span style="color: #666666">=</span>g(i)<span style="color: #666666">-</span>dg(i);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(i<span style="color: #666666">=0</span>;i<span style="color: #666666">&lt;</span>n;i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>hdg(i)<span style="color: #666666">=0.0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(j<span style="color: #666666">=0</span>;j<span style="color: #666666">&lt;</span>n;j<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>hdg(i)<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span>hessian(i,j)<span style="color: #666666">*</span>dg(j);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>fac<span style="color: #666666">=</span>fae<span style="color: #666666">=</span>sumdg<span style="color: #666666">=</span>sumxi<span style="color: #666666">=0.0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(i<span style="color: #666666">=0</span>;i<span style="color: #666666">&lt;</span>n;i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>fac<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span>dg(i)<span style="color: #666666">*</span>xi(i);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>fae<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span>dg(i)<span style="color: #666666">*</span>hdg(i);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>sumdg<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span>SQR(dg(i));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>sumxi<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span>SQR(xi(i));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(fac<span style="color: #666666">*</span>fac<span style="color: #bbbbbb"> </span><span style="color: #666666">&gt;</span><span style="color: #bbbbbb"> </span>EPS<span style="color: #666666">*</span>sumdg<span style="color: #666666">*</span>sumxi)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>fac<span style="color: #666666">=1.0/</span>fac;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>fad<span style="color: #666666">=1.0/</span>fae;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(i<span style="color: #666666">=0</span>;i<span style="color: #666666">&lt;</span>n;i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>dg(i)<span style="color: #666666">=</span>fac<span style="color: #666666">*</span>xi(i)<span style="color: #666666">-</span>fad<span style="color: #666666">*</span>hdg(i);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(i<span style="color: #666666">=0</span>;i<span style="color: #666666">&lt;</span>n;i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(j<span style="color: #666666">=0</span>;j<span style="color: #666666">&lt;</span>n;j<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	  </span>hessian(i,j)<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span>fac<span style="color: #666666">*</span>xi(i)<span style="color: #666666">*</span>xi(j)<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	    </span><span style="color: #666666">-</span>fad<span style="color: #666666">*</span>hdg(i)<span style="color: #666666">*</span>hdg(j)<span style="color: #666666">+</span>fae<span style="color: #666666">*</span>dg(i)<span style="color: #666666">*</span>dg(j);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(i<span style="color: #666666">=0</span>;i<span style="color: #666666">&lt;</span>n;i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>xi(i)<span style="color: #666666">=0.0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(j<span style="color: #666666">=0</span>;j<span style="color: #666666">&lt;</span>n;j<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>xi(i)<span style="color: #bbbbbb"> </span><span style="color: #666666">-=</span><span style="color: #bbbbbb"> </span>hessian(i,j)<span style="color: #666666">*</span>g(j);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>cout<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;too many iterations in dfpmin&quot;</span><span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>endl;<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb"></span>
<span style="color: #BC7A00">#undef ITMAX</span>
<span style="color: #BC7A00">#undef EPS</span>
<span style="color: #BC7A00">#undef TOLX</span>
<span style="color: #BC7A00">#undef STPMX</span>

<span style="color: #BC7A00">#define ALF 1.0e-4</span>
<span style="color: #BC7A00">#define TOLX 1.0e-7</span>

<span style="color: #B00040">void</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">lnsrch</span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>n,<span style="color: #bbbbbb"> </span>Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>xold,<span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>fold,<span style="color: #bbbbbb"> </span>Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>g,<span style="color: #bbbbbb"> </span>Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>p,<span style="color: #bbbbbb"> </span>Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>x,<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	    </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span><span style="color: #666666">*</span>f,<span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>stpmax,<span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span><span style="color: #666666">*</span>check,<span style="color: #bbbbbb"> </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>(<span style="color: #666666">*</span>func)(Vector<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>p))<span style="color: #bbbbbb"></span>
{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>i;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #B00040">double</span><span style="color: #bbbbbb"> </span>a,alam,alam2,alamin,b,disc,f2,fold2,rhs1,rhs2,slope,sum,temp,<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>test,tmplam;<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span><span style="color: #666666">*</span>check<span style="color: #666666">=0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(sum<span style="color: #666666">=0.0</span>,i<span style="color: #666666">=0</span>;i<span style="color: #666666">&lt;</span>n;i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>sum<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span>p(i)<span style="color: #666666">*</span>p(i);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>sum<span style="color: #666666">=</span>sqrt(sum);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(sum<span style="color: #bbbbbb"> </span><span style="color: #666666">&gt;</span><span style="color: #bbbbbb"> </span>stpmax)<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(i<span style="color: #666666">=0</span>;i<span style="color: #666666">&lt;</span>n;i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>p(i)<span style="color: #bbbbbb"> </span><span style="color: #666666">*=</span><span style="color: #bbbbbb"> </span>stpmax<span style="color: #666666">/</span>sum;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(slope<span style="color: #666666">=0.0</span>,i<span style="color: #666666">=0</span>;i<span style="color: #666666">&lt;</span>n;i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>slope<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span>g(i)<span style="color: #666666">*</span>p(i);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>test<span style="color: #666666">=0.0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(i<span style="color: #666666">=0</span>;i<span style="color: #666666">&lt;</span>n;i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>temp<span style="color: #666666">=</span>fabs(p(i))<span style="color: #666666">/</span>FMAX(fabs(xold(i)),<span style="color: #666666">1.0</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(temp<span style="color: #bbbbbb"> </span><span style="color: #666666">&gt;</span><span style="color: #bbbbbb"> </span>test)<span style="color: #bbbbbb"> </span>test<span style="color: #666666">=</span>temp;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>alamin<span style="color: #666666">=</span>TOLX<span style="color: #666666">/</span>test;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>alam<span style="color: #666666">=1.0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(;;)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(i<span style="color: #666666">=0</span>;i<span style="color: #666666">&lt;</span>n;i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>x(i)<span style="color: #666666">=</span>xold(i)<span style="color: #666666">+</span>alam<span style="color: #666666">*</span>p(i);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #666666">*</span>f<span style="color: #666666">=</span>(<span style="color: #666666">*</span>func)(x);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(alam<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span>alamin)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(i<span style="color: #666666">=0</span>;i<span style="color: #666666">&lt;</span>n;i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>x(i)<span style="color: #666666">=</span>xold(i);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #666666">*</span>check<span style="color: #666666">=1</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">return</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"> </span><span style="color: #008000; font-weight: bold">else</span><span style="color: #bbbbbb"> </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(<span style="color: #666666">*</span>f<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;=</span><span style="color: #bbbbbb"> </span>fold<span style="color: #666666">+</span>ALF<span style="color: #666666">*</span>alam<span style="color: #666666">*</span>slope)<span style="color: #bbbbbb"> </span><span style="color: #008000; font-weight: bold">return</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">else</span><span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(alam<span style="color: #bbbbbb"> </span><span style="color: #666666">==</span><span style="color: #bbbbbb"> </span><span style="color: #666666">1.0</span>)<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span>tmplam<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">-</span>slope<span style="color: #666666">/</span>(<span style="color: #666666">2.0*</span>(<span style="color: #666666">*</span>f<span style="color: #666666">-</span>fold<span style="color: #666666">-</span>slope));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">else</span><span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span>rhs1<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">*</span>f<span style="color: #666666">-</span>fold<span style="color: #666666">-</span>alam<span style="color: #666666">*</span>slope;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span>rhs2<span style="color: #666666">=</span>f2<span style="color: #666666">-</span>fold2<span style="color: #666666">-</span>alam2<span style="color: #666666">*</span>slope;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span>a<span style="color: #666666">=</span>(rhs1<span style="color: #666666">/</span>(alam<span style="color: #666666">*</span>alam)<span style="color: #666666">-</span>rhs2<span style="color: #666666">/</span>(alam2<span style="color: #666666">*</span>alam2))<span style="color: #666666">/</span>(alam<span style="color: #666666">-</span>alam2);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span>b<span style="color: #666666">=</span>(<span style="color: #666666">-</span>alam2<span style="color: #666666">*</span>rhs1<span style="color: #666666">/</span>(alam<span style="color: #666666">*</span>alam)<span style="color: #666666">+</span>alam<span style="color: #666666">*</span>rhs2<span style="color: #666666">/</span>(alam2<span style="color: #666666">*</span>alam2))<span style="color: #666666">/</span>(alam<span style="color: #666666">-</span>alam2);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(a<span style="color: #bbbbbb"> </span><span style="color: #666666">==</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0.0</span>)<span style="color: #bbbbbb"> </span>tmplam<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">-</span>slope<span style="color: #666666">/</span>(<span style="color: #666666">2.0*</span>b);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span><span style="color: #008000; font-weight: bold">else</span><span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	  </span>disc<span style="color: #666666">=</span>b<span style="color: #666666">*</span>b<span style="color: #666666">-3.0*</span>a<span style="color: #666666">*</span>slope;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	  </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(disc<span style="color: #666666">&lt;0.0</span>)<span style="color: #bbbbbb"> </span>cout<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;Roundoff problem in lnsrch.&quot;</span><span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;&lt;</span><span style="color: #bbbbbb"> </span>endl;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	  </span><span style="color: #008000; font-weight: bold">else</span><span style="color: #bbbbbb"> </span>tmplam<span style="color: #666666">=</span>(<span style="color: #666666">-</span>b<span style="color: #666666">+</span>sqrt(disc))<span style="color: #666666">/</span>(<span style="color: #666666">3.0*</span>a);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(tmplam<span style="color: #666666">&gt;0.5*</span>alam)<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">	  </span>tmplam<span style="color: #666666">=0.5*</span>alam;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>alam2<span style="color: #666666">=</span>alam;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>f2<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">*</span>f;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>fold2<span style="color: #666666">=</span>fold;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>alam<span style="color: #666666">=</span>FMAX(tmplam,<span style="color: #666666">0.1*</span>alam);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb"></span>
<span style="color: #BC7A00">#undef ALF</span>
<span style="color: #BC7A00">#undef TOLX</span>
</pre>
</div>
      </div>
    </div>
  </div>
  <div class="output_wrapper">
    <div class="output">
      <div class="output_area">
        <div class="output_subarea output_stream output_stdout output_text">          
        </div>
      </div>
    </div>
  </div>
</div>
</div>
</div>


<p>
<!-- navigation buttons at the bottom of the page -->
<ul class="pagination">
<li><a href="._week9-bs102.html">&laquo;</a></li>
  <li><a href="._week9-bs000.html">1</a></li>
  <li><a href="">...</a></li>
  <li><a href="._week9-bs095.html">96</a></li>
  <li><a href="._week9-bs096.html">97</a></li>
  <li><a href="._week9-bs097.html">98</a></li>
  <li><a href="._week9-bs098.html">99</a></li>
  <li><a href="._week9-bs099.html">100</a></li>
  <li><a href="._week9-bs100.html">101</a></li>
  <li><a href="._week9-bs101.html">102</a></li>
  <li><a href="._week9-bs102.html">103</a></li>
  <li class="active"><a href="._week9-bs103.html">104</a></li>
  <li><a href="._week9-bs104.html">105</a></li>
  <li><a href="._week9-bs105.html">106</a></li>
  <li><a href="._week9-bs106.html">107</a></li>
  <li><a href="._week9-bs107.html">108</a></li>
  <li><a href="._week9-bs108.html">109</a></li>
  <li><a href="._week9-bs109.html">110</a></li>
  <li><a href="._week9-bs110.html">111</a></li>
  <li><a href="._week9-bs111.html">112</a></li>
  <li><a href="._week9-bs112.html">113</a></li>
  <li><a href="">...</a></li>
  <li><a href="._week9-bs141.html">142</a></li>
  <li><a href="._week9-bs104.html">&raquo;</a></li>
</ul>
<!-- ------------------- end of main content --------------- -->
</div>  <!-- end container -->
<!-- include javascript, jQuery *first* -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<!-- Bootstrap footer
<footer>
<a href="https://..."><img width="250" align=right src="https://..."></a>
</footer>
-->
<center style="font-size:80%">
<!-- copyright only on the titlepage -->
</center>
</body>
</html>

